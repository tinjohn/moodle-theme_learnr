{"version":3,"file":"dynprbar.min.js","sources":["../src/dynprbar.js"],"sourcesContent":["export const init = () => {\n    window.addEventListener('load', function () {\n        var pr = document.getElementsByClassName('progress')[0];\n        const prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n        alert('pr' + pr);\n        alert('prbar' + prbar);\n    });\n\n// https://riptutorial.com/javascript/example/20197/listening-to-ajax-events-at-a-global-level\n// Store a reference to the native method\nlet send = XMLHttpRequest.prototype.send;\nconst prbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n// console.log(document.getElementsByClassName('progress-bar progress-bar-infos')[0]);\n\n    // Overwrite the native method\n    XMLHttpRequest.prototype.send = function() {\n        // tinjohn get Request Payload from send arguments\n        var payload = arguments[0];\n        if(payload === null) {\n            send.apply(this, arguments);\n            return;\n        }\n        alert(\"arguments 0 send-----\" + payload);\n        var isValidJSON = true;\n        try {\n            JSON.parse(payload);\n        } catch {\n            isValidJSON = false;\n        }\n        if(isValidJSON) {\n            // Assign an event listener\n            // and remove it again\n            // https://www.mediaevent.de/javascript/remove-event-listener.html\n            this.addEventListener(\"load\", function removeMe () {\n                readAJAXrequestsend(payload);\n                this.removeEventListener(\"load\", removeMe);\n            }, false);\n        }\n        // Call the stored reference to the native method\n        send.apply(this, arguments);\n    };\n\n    /**\n     * Reads payload and calls function addProgress (h5p activities need an outside call) or reduces progress bar.\n     * @param {payload} payload from request.\n     */\n    function readAJAXrequestsend (payload) {\n        //console.log(\"readAJAXrequestsend-----payload---------\" + payload);\n        var isValidJSON = true;\n        try {\n            JSON.parse(payload);\n        } catch {\n            isValidJSON = false;\n        }\n        if(isValidJSON) {\n            const plo = JSON.parse(payload);\n            //console.log(plo[0]);\n            /*\n            console.log(plo[0].methodname);\n            console.log(plo[0].args.cmid);\n            console.log(plo[0].args.completed);\n            */\n            // update_activity_completion_status_manually in completion/external.php\n            if (plo[0].methodname.match(\"(.*)core_completion_update_activity_completion_status_manually(.*)\"))\n            {\n                if (plo[0].args.completed) {\n                    addProgress();\n                } else {\n                    var newwidth = parseInt(prbar.style.width) - parseInt(prbar.getAttribute('progress-steps'));\n                    if((parseInt(prbar.style.width) - parseInt(prbar.getAttribute('progress-steps'))) < 0) {\n                        var newwidth = 0;\n                    }\n                    prbar.style.width = newwidth + '%';\n                }\n            }\n            if (plo[0].methodname.match(\"(.*)core_xapi_statement_post(.*)\"))\n            {\n                isValidJSON = true;\n                try {JSON.parse(plo[0].args.requestjson);} catch {isValidJSON = false;}\n                if(isValidJSON) {\n                    const xapiReq = JSON.parse(plo[0].args.requestjson);\n                    //console.log(xapiReq);\n                    if (xapiReq[0].result.completion && xapiReq[0].result.success)\n                    {\n                        // check if initially successed already - in completemods thus send the context id\n                        var contextid = xapiReq[0].object.id;\n                        var sender = xapiReq[0].actor.account.homepage;\n                        // it is an iframe - hook is in the iframe call addProgress to window.parent\n                        window.parent.postMessage({method : \"addProgress\", contextid : contextid}, sender);\n                    }\n                }\n            }\n            payload = '';\n        }\n    }\n\n    /**\n     * Add progress whenever context.id module was not completed on inital load.\n     * @param {contextid} contextid the object.id from request.\n     */\n    function addProgress (contextid) {\n        const iframeprbar = document.getElementsByClassName('progress-bar progress-bar-info')[0];\n        if(iframeprbar === null) {\n            return;\n        }\n        if(contextid !== null) {\n            const completedmods = iframeprbar.getAttribute('completedmods');\n            if(completedmods.match('(.*)' + contextid + '(.*)')) {\n                //console.log(contextid + \" war schon fertig\");\n                return;\n            }\n        }\n        iframeprbar.style.width = (parseInt(iframeprbar.style.width) + parseInt(iframeprbar.getAttribute('progress-steps'))) + '%';\n    }\n\n    window.addEventListener('message', function(e) {\n        //console.log('---got mail from iframe---', e.data);\n        if(e.data.method == 'addProgress') {\n            const [, contextid] = e.data.contextid.split(/\\/(?=[^\\/]+$)/);\n            addProgress(contextid);\n        }\n    });\n};"],"names":["window","addEventListener","pr","document","getElementsByClassName","prbar","alert","send","XMLHttpRequest","prototype","readAJAXrequestsend","payload","isValidJSON","JSON","parse","plo","methodname","match","args","completed","addProgress","newwidth","parseInt","style","width","getAttribute","requestjson","xapiReq","result","completion","success","contextid","object","id","sender","actor","account","homepage","parent","postMessage","method","iframeprbar","arguments","removeMe","removeEventListener","apply","this","e","data","split"],"mappings":"0JAAoB,KAChBA,OAAOC,iBAAiB,QAAQ,eACxBC,GAAKC,SAASC,uBAAuB,YAAY,SAC/CC,MAAQF,SAASC,uBAAuB,kCAAkC,GAChFE,MAAM,KAAOJ,IACbI,MAAM,QAAUD,cAKpBE,KAAOC,eAAeC,UAAUF,WAC9BF,MAAQF,SAASC,uBAAuB,kCAAkC,YAmCnEM,oBAAqBC,aAEtBC,aAAc,MAEdC,KAAKC,MAAMH,SACb,MACEC,aAAc,KAEfA,YAAa,OACNG,IAAMF,KAAKC,MAAMH,YAQnBI,IAAI,GAAGC,WAAWC,MAAM,yEAEpBF,IAAI,GAAGG,KAAKC,UACZC,kBACG,KACCC,SAAWC,SAASjB,MAAMkB,MAAMC,OAASF,SAASjB,MAAMoB,aAAa,sBACrEH,SAASjB,MAAMkB,MAAMC,OAASF,SAASjB,MAAMoB,aAAa,mBAAsB,EAC5EJ,SAAW,EAEnBhB,MAAMkB,MAAMC,MAAQH,SAAW,OAGnCN,IAAI,GAAGC,WAAWC,MAAM,oCAC5B,CACIL,aAAc,MACTC,KAAKC,MAAMC,IAAI,GAAGG,KAAKQ,aAAe,MAAOd,aAAc,KAC7DA,YAAa,OACNe,QAAUd,KAAKC,MAAMC,IAAI,GAAGG,KAAKQ,gBAEnCC,QAAQ,GAAGC,OAAOC,YAAcF,QAAQ,GAAGC,OAAOE,QACtD,KAEQC,UAAYJ,QAAQ,GAAGK,OAAOC,GAC9BC,OAASP,QAAQ,GAAGQ,MAAMC,QAAQC,SAEtCrC,OAAOsC,OAAOC,YAAY,CAACC,OAAS,cAAeT,UAAYA,WAAYG,UAIvFvB,QAAU,aAQTS,YAAaW,iBACZU,YAActC,SAASC,uBAAuB,kCAAkC,MACnE,OAAhBqC,gBAGc,OAAdV,UAAoB,IACGU,YAAYhB,aAAa,iBAC9BR,MAAM,OAASc,UAAY,eAKhDU,YAAYlB,MAAMC,MAASF,SAASmB,YAAYlB,MAAMC,OAASF,SAASmB,YAAYhB,aAAa,mBAAsB,KAjG3HjB,eAAeC,UAAUF,KAAO,eAExBI,QAAU+B,UAAU,MACT,OAAZ/B,SAIHL,MAAM,wBAA0BK,aAC5BC,aAAc,MAEdC,KAAKC,MAAMH,SACb,MACEC,aAAc,EAEfA,kBAIMX,iBAAiB,QAAQ,SAAS0C,WACnCjC,oBAAoBC,cACfiC,oBAAoB,OAAQD,aAClC,GAGPpC,KAAKsC,MAAMC,KAAMJ,gBApBbnC,KAAKsC,MAAMC,KAAMJ,YAgGzB1C,OAAOC,iBAAiB,WAAW,SAAS8C,MAEpB,eAAjBA,EAAEC,KAAKR,OAAyB,QACtBT,WAAagB,EAAEC,KAAKjB,UAAUkB,MAAM,iBAC7C7B,YAAYW"}